[
  {
    "id": "778fe590ae6f3a0e",
    "type": "subflow",
    "name": "ns panel notification action timeout",
    "info": "Wait for NS Panel notification action, with timeout\n\n### Configuration\n\n#### `NS Panels required`\n\n- Type: `list`\n- Accepts [Mustache Templates](https://github.com/janl/mustache.js)\n\nA list of NS Panel names where to listening for notification action\n\n#### `Timeout required`\n\n- Type: `number`\n- Accepts [Mustache Templates](https://github.com/janl/mustache.js)\n\nThe timeout in seconds used for the notification\n\n#### `Remain required`\n\n- Type: `bool`\n\nIf the notification should remain on other ns panels when actioned.\n\n## Output\n\nValue types:\n\n- `NS Panel`: the ns panel where the action occurred\n",
    "category": "ns_panel",
    "in": [
      {
        "x": 60,
        "y": 120,
        "wires": [
          {
            "id": "9be0f73334cd4192"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 480,
        "y": 400,
        "wires": [
          {
            "id": "ee84f05f5c5fa086",
            "port": 0
          }
        ]
      },
      {
        "x": 480,
        "y": 560,
        "wires": [
          {
            "id": "b3b5f4055b818cb6",
            "port": 0
          }
        ]
      },
      {
        "x": 480,
        "y": 720,
        "wires": [
          {
            "id": "2ce048ed0ef1b93a",
            "port": 0
          }
        ]
      }
    ],
    "env": [
      {
        "name": "ns_panels",
        "type": "json",
        "value": "[]",
        "ui": {
          "label": {
            "en-US": "NS Panels"
          },
          "type": "input",
          "opts": {
            "types": [
              "str",
              "json"
            ]
          }
        }
      },
      {
        "name": "timeout",
        "type": "num",
        "value": "60",
        "ui": {
          "label": {
            "en-US": "Timeout"
          },
          "type": "input",
          "opts": {
            "types": [
              "str",
              "num"
            ]
          }
        }
      },
      {
        "name": "remain",
        "type": "bool",
        "value": "false",
        "ui": {
          "label": {
            "en-US": "remain"
          },
          "type": "input",
          "opts": {
            "types": [
              "bool"
            ]
          }
        }
      },
      {
        "name": "output_ns_panel",
        "type": "str",
        "value": "",
        "ui": {
          "icon": "font-awesome/fa-sign-out",
          "label": {
            "en-US": "NS Panel"
          },
          "type": "input",
          "opts": {
            "types": [
              "str"
            ]
          }
        }
      }
    ],
    "meta": {},
    "color": "#DDAA99",
    "outputLabels": [
      "accepted",
      "declined",
      "timed out"
    ],
    "status": {
      "x": 140,
      "y": 60,
      "wires": [
        {
          "id": "6b483041cf5a0623",
          "port": 0
        }
      ]
    }
  },
  {
    "id": "d46fd1b35ef9ca57",
    "type": "group",
    "z": "778fe590ae6f3a0e",
    "name": "Accepted",
    "style": {
      "label": true
    },
    "nodes": [
      "72d9192fd41e46f6",
      "f534f872a0aed22f",
      "ee84f05f5c5fa086",
      "4fbf84f17931c2ef"
    ],
    "x": 44,
    "y": 359
  },
  {
    "id": "0bd0c07fe83bbf42",
    "type": "group",
    "z": "778fe590ae6f3a0e",
    "name": "Declined",
    "style": {
      "label": true
    },
    "nodes": [
      "8520d69db5837f4a",
      "441b423bb47d7970",
      "b3b5f4055b818cb6",
      "3ae2c279dfe1508e"
    ],
    "x": 44,
    "y": 519
  },
  {
    "id": "444e42c64c38a30d",
    "type": "group",
    "z": "778fe590ae6f3a0e",
    "name": "Timed out",
    "style": {
      "label": true
    },
    "nodes": [
      "83e380b194dda3f8",
      "a974b819e2404ab1",
      "2ce048ed0ef1b93a",
      "209741e5871c5cd4"
    ],
    "x": 44,
    "y": 679
  },
  {
    "id": "1ef2b5623052cfeb",
    "type": "group",
    "z": "778fe590ae6f3a0e",
    "name": "Action",
    "style": {
      "label": true
    },
    "nodes": [
      "0feb816c500ecc36",
      "42e0490e73500f90",
      "ddac6db506b0c1c4",
      "10649458e737eae7",
      "4a175fcb89f9107f",
      "3383bff18a8d4c5f",
      "baac416772f635f6",
      "d3b359360a74acf1"
    ],
    "x": 54,
    "y": 199
  },
  {
    "id": "a8b61fd733d27b45",
    "type": "ha-wait-until",
    "z": "778fe590ae6f3a0e",
    "name": "wait for action",
    "server": "e9739673.bbfed8",
    "version": 2,
    "outputs": 2,
    "entityIdFilterType": "exact",
    "property": "state",
    "comparator": "is",
    "value": "notificationclearrelease$|notificationacceptrelease$",
    "valueType": "re",
    "timeout": "ns_panel_notification_action_timeout.timeout",
    "timeoutType": "jsonata",
    "timeoutUnits": "seconds",
    "checkCurrentState": true,
    "blockInputOverrides": false,
    "outputProperties": [
      {
        "property": "entity",
        "propertyType": "msg",
        "value": "",
        "valueType": "entity"
      }
    ],
    "entityLocation": "data",
    "entityLocationType": "none",
    "x": 640,
    "y": 120,
    "wires": [
      [
        "e41c20ab93af3f94"
      ],
      [
        "0bec1e4791e8f339"
      ]
    ]
  },
  {
    "id": "9be0f73334cd4192",
    "type": "subflow:846b2a595d7e7acf",
    "z": "778fe590ae6f3a0e",
    "name": "",
    "env": [
      {
        "name": "unique_id",
        "value": "ns_panel_notification_action_timeout",
        "type": "str"
      },
      {
        "name": "entries",
        "value": "[\"ns_panels\",\"timeout\",\"remain\"]",
        "type": "json"
      }
    ],
    "x": 200,
    "y": 120,
    "wires": [
      [
        "ba68b298c9295f36",
        "db5fead55bef90ca"
      ]
    ]
  },
  {
    "id": "ba68b298c9295f36",
    "type": "function",
    "z": "778fe590ae6f3a0e",
    "name": "create status",
    "func": "const text = 'waiting for action';\n\nreturn {\n    payload: {\n        fill: 'yellow',\n        text\n    }\n};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 390,
    "y": 60,
    "wires": [
      [
        "a4511aab0daa2605"
      ]
    ]
  },
  {
    "id": "6b483041cf5a0623",
    "type": "link in",
    "z": "778fe590ae6f3a0e",
    "name": "status",
    "links": [
      "3ae2c279dfe1508e",
      "4fbf84f17931c2ef",
      "83e380b194dda3f8",
      "a4511aab0daa2605"
    ],
    "x": 65,
    "y": 60,
    "wires": [
      []
    ]
  },
  {
    "id": "a4511aab0daa2605",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "name": "show status",
    "mode": "link",
    "links": [
      "6b483041cf5a0623"
    ],
    "x": 505,
    "y": 60,
    "wires": []
  },
  {
    "id": "72d9192fd41e46f6",
    "type": "link in",
    "z": "778fe590ae6f3a0e",
    "g": "d46fd1b35ef9ca57",
    "name": "accepted",
    "links": [
      "ddac6db506b0c1c4"
    ],
    "x": 85,
    "y": 400,
    "wires": [
      [
        "ee84f05f5c5fa086",
        "f534f872a0aed22f"
      ]
    ]
  },
  {
    "id": "8520d69db5837f4a",
    "type": "link in",
    "z": "778fe590ae6f3a0e",
    "g": "0bd0c07fe83bbf42",
    "name": "declined",
    "links": [
      "10649458e737eae7"
    ],
    "x": 85,
    "y": 560,
    "wires": [
      [
        "b3b5f4055b818cb6",
        "441b423bb47d7970"
      ]
    ]
  },
  {
    "id": "f534f872a0aed22f",
    "type": "function",
    "z": "778fe590ae6f3a0e",
    "g": "d46fd1b35ef9ca57",
    "name": "create status",
    "func": "const text = 'accepted';\n\nreturn {\n    payload: {\n        fill: 'green',\n        text\n    }\n};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 210,
    "y": 460,
    "wires": [
      [
        "4fbf84f17931c2ef"
      ]
    ]
  },
  {
    "id": "ee84f05f5c5fa086",
    "type": "subflow:667ec96ed52e720e",
    "z": "778fe590ae6f3a0e",
    "g": "d46fd1b35ef9ca57",
    "name": "",
    "env": [
      {
        "name": "unique_id",
        "value": "ns_panel_notification_action_timeout",
        "type": "str"
      },
      {
        "name": "outputs",
        "value": "{\"output_ns_panel\":\"ns_panel\"}",
        "type": "json"
      }
    ],
    "x": 220,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "4fbf84f17931c2ef",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "g": "d46fd1b35ef9ca57",
    "name": "show status",
    "mode": "link",
    "links": [
      "6b483041cf5a0623"
    ],
    "x": 335,
    "y": 460,
    "wires": []
  },
  {
    "id": "441b423bb47d7970",
    "type": "function",
    "z": "778fe590ae6f3a0e",
    "g": "0bd0c07fe83bbf42",
    "name": "create status",
    "func": "const text = 'declined';\n\nreturn {\n    payload: {\n        fill: 'red',\n        shape: 'ring',\n        text\n    }\n};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 210,
    "y": 620,
    "wires": [
      [
        "3ae2c279dfe1508e"
      ]
    ]
  },
  {
    "id": "b3b5f4055b818cb6",
    "type": "subflow:667ec96ed52e720e",
    "z": "778fe590ae6f3a0e",
    "g": "0bd0c07fe83bbf42",
    "name": "",
    "env": [
      {
        "name": "unique_id",
        "value": "ns_panel_notification_action_timeout",
        "type": "str"
      },
      {
        "name": "outputs",
        "value": "{\"output_ns_panel\":\"ns_panel\"}",
        "type": "json"
      }
    ],
    "x": 220,
    "y": 560,
    "wires": [
      []
    ]
  },
  {
    "id": "3ae2c279dfe1508e",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "g": "0bd0c07fe83bbf42",
    "name": "show status",
    "mode": "link",
    "links": [
      "6b483041cf5a0623"
    ],
    "x": 335,
    "y": 620,
    "wires": []
  },
  {
    "id": "83e380b194dda3f8",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "g": "444e42c64c38a30d",
    "name": "show status",
    "mode": "link",
    "links": [
      "6b483041cf5a0623"
    ],
    "x": 335,
    "y": 780,
    "wires": []
  },
  {
    "id": "a974b819e2404ab1",
    "type": "function",
    "z": "778fe590ae6f3a0e",
    "g": "444e42c64c38a30d",
    "name": "create status",
    "func": "const text = 'timed out';\n\nreturn {\n    payload: {\n        fill: 'red',\n        text\n    }\n};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 210,
    "y": 780,
    "wires": [
      [
        "83e380b194dda3f8"
      ]
    ]
  },
  {
    "id": "2ce048ed0ef1b93a",
    "type": "subflow:667ec96ed52e720e",
    "z": "778fe590ae6f3a0e",
    "g": "444e42c64c38a30d",
    "name": "",
    "env": [
      {
        "name": "unique_id",
        "value": "ns_panel_notification_action_timeout",
        "type": "str"
      }
    ],
    "x": 220,
    "y": 720,
    "wires": [
      []
    ]
  },
  {
    "id": "209741e5871c5cd4",
    "type": "link in",
    "z": "778fe590ae6f3a0e",
    "g": "444e42c64c38a30d",
    "name": "timed out",
    "links": [
      "0bec1e4791e8f339"
    ],
    "x": 85,
    "y": 720,
    "wires": [
      [
        "2ce048ed0ef1b93a",
        "a974b819e2404ab1"
      ]
    ]
  },
  {
    "id": "0bec1e4791e8f339",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "name": "timed out",
    "mode": "link",
    "links": [
      "209741e5871c5cd4"
    ],
    "x": 775,
    "y": 140,
    "wires": []
  },
  {
    "id": "0feb816c500ecc36",
    "type": "link in",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "action",
    "links": [
      "e41c20ab93af3f94"
    ],
    "x": 95,
    "y": 260,
    "wires": [
      [
        "4a175fcb89f9107f",
        "3383bff18a8d4c5f"
      ]
    ]
  },
  {
    "id": "e41c20ab93af3f94",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "name": "action",
    "mode": "link",
    "links": [
      "0feb816c500ecc36"
    ],
    "x": 775,
    "y": 80,
    "wires": []
  },
  {
    "id": "42e0490e73500f90",
    "type": "switch",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "accepted?",
    "property": "entity.state",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "notificationacceptrelease",
        "vt": "str"
      },
      {
        "t": "else"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 2,
    "x": 460,
    "y": 260,
    "wires": [
      [
        "ddac6db506b0c1c4"
      ],
      [
        "10649458e737eae7"
      ]
    ]
  },
  {
    "id": "ddac6db506b0c1c4",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "accepted",
    "mode": "link",
    "links": [
      "72d9192fd41e46f6"
    ],
    "x": 585,
    "y": 240,
    "wires": []
  },
  {
    "id": "10649458e737eae7",
    "type": "link out",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "declined",
    "mode": "link",
    "links": [
      "8520d69db5837f4a"
    ],
    "x": 585,
    "y": 280,
    "wires": []
  },
  {
    "id": "4a175fcb89f9107f",
    "type": "function",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "get actioned ns panel ",
    "func": "const last_click_entity = msg.entity.entity_id;\nconst ns_panel = /sensor.(.*)_last_click/g.exec(last_click_entity)[1];\n\nreturn {\n    ...msg,\n    ns_panel\n}",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 250,
    "y": 260,
    "wires": [
      [
        "42e0490e73500f90"
      ]
    ]
  },
  {
    "id": "db5fead55bef90ca",
    "type": "function",
    "z": "778fe590ae6f3a0e",
    "name": "create last_click regex",
    "func": "const ns_panels = msg.ns_panel_notification_action_timeout.ns_panels;\nconst sensors = ns_panels.map((ns_panel) => `sensor.${ns_panel}_last_click$`);\nconst last_click_regex = sensors.join('|');\n\nreturn {\n    ...msg,\n    payload: {\n        entity_id: last_click_regex,\n        entityIdFilterType: 'regex',\n    }\n};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 420,
    "y": 120,
    "wires": [
      [
        "a8b61fd733d27b45"
      ]
    ]
  },
  {
    "id": "3383bff18a8d4c5f",
    "type": "switch",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "not remain?",
    "property": "ns_panel_notification_action_timeout.remain",
    "propertyType": "msg",
    "rules": [
      {
        "t": "false"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 1,
    "x": 220,
    "y": 300,
    "wires": [
      [
        "baac416772f635f6"
      ]
    ]
  },
  {
    "id": "baac416772f635f6",
    "type": "subflow:ae792429f867c954",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "",
    "env": [
      {
        "name": "ns_panels",
        "value": "{{ns_panel_notification_action_timeout.ns_panels}}",
        "type": "str"
      }
    ],
    "x": 440,
    "y": 300,
    "wires": [
      []
    ]
  },
  {
    "id": "6a40162a69ce7fd0",
    "type": "comment",
    "z": "778fe590ae6f3a0e",
    "name": "Last click is gone",
    "info": "",
    "x": 400,
    "y": 160,
    "wires": []
  },
  {
    "id": "d3b359360a74acf1",
    "type": "comment",
    "z": "778fe590ae6f3a0e",
    "g": "1ef2b5623052cfeb",
    "name": "Last click is gone",
    "info": "",
    "x": 220,
    "y": 340,
    "wires": []
  }
]